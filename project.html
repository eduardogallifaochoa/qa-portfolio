<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Project · Preview</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --link:#0366d6; --border:#e5e7eb; --bg:#fff; --fg:#111827; --muted:#6b7280; }
    * { box-sizing:border-box; }
    body { font-family: system-ui, Arial; margin: 24px; line-height:1.55; background:#fafafa; color:var(--fg); }
    header, main { max-width: 980px; margin: 0 auto; }
    header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom: 14px; }
    h1 { margin:0; font-size: 22px; }
    nav a { color: var(--link); text-decoration: none; margin-left: 8px; }
    .muted { color:var(--muted); font-size:14px; }
    .card { border:1px solid var(--border); border-radius:14px; padding:18px; background:var(--bg); }
    pre { overflow:auto; background:#0f172a; color:#e5e7eb; padding:14px; border-radius:10px; }
    img { max-width: 100%; height: auto; }
    @media (prefers-color-scheme: dark) { :root { --link:#60a5fa; --border:#1f2937; --bg:#111827; --fg:#e5e7eb; --muted:#9ca3af; } body { background:#0f1117; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
  <header>
    <div>
      <a href="#" id="backLink" aria-label="Back">← Back</a>
      <h1 id="title" style="display:inline-block; margin-left:8px;">Project Preview</h1>
      <span id="repoMeta" class="muted" style="margin-left:8px;"></span>
    </div>
    <nav><a id="openOnGitHub" href="#" target="_blank" rel="noopener">GitHub ↗</a></nav>
  </header>

  <main class="card"><div id="content">Loading README…</div></main>

  <script>
    const params = new URLSearchParams(location.search);
    const repo = params.get('repo');
    const niceTitle = params.get('title') || repo || 'Project Preview';
    const returnParam = params.get('return');

    const $ = (s) => document.querySelector(s);
    $('#title').textContent = niceTitle;
    $('#repoMeta').textContent = repo ? `${repo}` : '';
    $('#openOnGitHub').href = repo ? `https://github.com/${repo}` : '#';

    // Back link
    $('#backLink').addEventListener('click', (e) => {
      e.preventDefault();
      if (returnParam) { location.href = returnParam; return; }
      if (document.referrer && new URL(document.referrer).origin === location.origin && history.length > 1) {
        history.back(); return;
      }
      const baseDir = location.pathname.replace(/\/[^\/]*$/, '/');
      location.href = baseDir;
    });

    if (!repo) { $('#content').textContent = 'Missing ?repo=:owner/:name'; throw new Error('Missing repo'); }

    async function getDefaultBranch(ownerRepo) {
      const api = `https://api.github.com/repos/${ownerRepo}`;
      const r = await fetch(api, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!r.ok) throw new Error(`GitHub API error: ${r.status}`);
      const j = await r.json();
      return j.default_branch || 'main';
    }
    async function fetchFirstOK(urls) {
      for (const u of urls) { try { const r = await fetch(u, { cache: 'no-store' }); if (r.ok) return await r.text(); } catch {} }
      throw new Error('All candidates failed');
    }
    function absolutizeLinks(container, baseRaw, baseBlob) {
      container.querySelectorAll('img').forEach(img => {
        const src = img.getAttribute('src') || '';
        if (!/^https?:\/\//i.test(src) && !src.startsWith('data:') && !src.startsWith('#')) {
          img.src = baseRaw + src.replace(/^\.\//, '');
        }
      });
      container.querySelectorAll('a').forEach(a => {
        const href = a.getAttribute('href') || '';
        if (!/^https?:\/\//i.test(href) && !href.startsWith('#') && !href.startsWith('mailto:')) {
          a.href = baseBlob + href.replace(/^\.\//, '');
          a.setAttribute('target', '_blank'); a.setAttribute('rel', 'noopener');
        }
      });
    }
    function renderReadme(md, baseRaw, baseBlob, branch) {
      const html = DOMPurify.sanitize(marked.parse(md));
      const el = document.createElement('div'); el.innerHTML = html;
      absolutizeLinks(el, baseRaw, baseBlob);
      $('#content').innerHTML = ''; $('#content').appendChild(el);
      const span = document.createElement('span'); span.className = 'muted'; span.style.marginLeft = '8px'; span.textContent = `· branch: ${branch}`;
      $('#repoMeta').appendChild(span);
    }

    (async () => {
      const fallbackBranches = ['main', 'master', 'dev', 'gh-pages'];
      let branchFromAPI = null; try { branchFromAPI = await getDefaultBranch(repo); } catch {}
      const branches = branchFromAPI ? [branchFromAPI, ...fallbackBranches.filter(b => b !== branchFromAPI)] : fallbackBranches;
      const filenames = ['README.md','readme.md','README.MD','README.rst','docs/README.md','Readme.md','README.txt'];

      for (const b of branches) {
        const baseRaw  = `https://raw.githubusercontent.com/${repo}/${b}/`;
        const baseBlob = `https://github.com/${repo}/blob/${b}/`;
        try {
          const md = await fetchFirstOK(filenames.map(fn => baseRaw + fn));
          renderReadme(md, baseRaw, baseBlob, b);
          return;
        } catch {}
      }
      $('#content').innerHTML = `
        <p><strong>Failed to load README</strong></p>
        <p class="muted">Tried branches: ${branches.join(', ')}</p>
        <p class="muted">Tried filenames: ${filenames.join(', ')}</p>
        <p><a href="https://github.com/${repo}" target="_blank" rel="noopener">Open on GitHub ↗</a></p>
      `;
    })();
  </script>
</body>
</html>
