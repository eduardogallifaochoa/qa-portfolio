<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>Project · Preview</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --link:#0366d6; --border:#e5e7eb; --bg:#fff; --fg:#111827; }
    body { font-family: system-ui, Arial; margin: 24px; line-height:1.55; background:#fafafa; color:var(--fg); }
    header, main { max-width: 980px; margin: 0 auto; }
    header { display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; margin-bottom: 14px; }
    a { color: var(--link); text-decoration: none; }
    .muted { color:#6b7280; font-size:14px; }
    .card { border:1px solid var(--border); border-radius:14px; padding:18px; background:var(--bg); }
    pre { overflow:auto; background:#0f172a; color:#e5e7eb; padding:14px; border-radius:10px; }
    img { max-width: 100%; height: auto; }
    @media (prefers-color-scheme: dark) {
      :root { --link:#60a5fa; --border:#1f2937; --bg:#111827; --fg:#e5e7eb; }
      body { background:#0f1117; }
      .muted { color:#9ca3af; }
    }
  </style>
  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
  <header>
    <h1 id="title" style="margin:0;">Project Preview</h1>
    <span class="muted" id="meta"></span>
  </header>

  <main class="card">
    <div id="content">Cargando README…</div>
  </main>

  <script>
    // --- Helpers ---
    const $ = (sel) => document.querySelector(sel);
    const params = new URLSearchParams(location.search);
    const repo = params.get('repo');            // e.g. "owner/name"
    const niceTitle = params.get('title') || repo || 'Project Preview';

    $('#title').textContent = niceTitle;
    $('#meta').innerHTML = repo
      ? `<a href="https://github.com/${repo}" target="_blank" rel="noopener">GitHub ↗</a>`
      : '';

    if (!repo) {
      $('#content').textContent = 'Missing ?repo=:owner/:name';
      throw new Error('Missing repo param');
    }

    // Detect default branch from GitHub API (unauthenticated; 60 req/h IP limit)
    async function getDefaultBranch(ownerRepo) {
      const api = `https://api.github.com/repos/${ownerRepo}`;
      const r = await fetch(api, { headers: { 'Accept': 'application/vnd.github+json' }});
      if (!r.ok) throw new Error(`GitHub API error: ${r.status}`);
      const j = await r.json();
      return j.default_branch || 'main';
    }

    // Try a list of README candidates
    async function fetchFirstOK(urls) {
      for (const u of urls) {
        try {
          const r = await fetch(u, { cache: 'no-store' });
          if (r.ok) return await r.text();
        } catch {}
      }
      throw new Error('All README candidates failed');
    }

    function absolutizeLinks(container, baseRaw) {
      // Fix relative <img src> and <a href>
      container.querySelectorAll('img').forEach(img => {
        const src = img.getAttribute('src') || '';
        if (!/^https?:\/\//i.test(src) && !src.startsWith('data:') && !src.startsWith('#')) {
          img.src = baseRaw + src.replace(/^\.\//, '');
        }
      });
      container.querySelectorAll('a').forEach(a => {
        const href = a.getAttribute('href') || '';
        if (!/^https?:\/\//i.test(href) && !href.startsWith('#') && !href.startsWith('mailto:')) {
          a.href = baseRaw + href.replace(/^\.\//, '');
        }
      });
    }

    (async () => {
      try {
        const branch = await getDefaultBranch(repo); // handles master/main automatically
        const base = `https://raw.githubusercontent.com/${repo}/${branch}/`;
        const candidates = [
          base + 'README.md',
          base + 'readme.md',
          base + 'README.MD',
          base + 'README.rst',
          base + 'docs/README.md',
        ];

        const md = await fetchFirstOK(candidates);
        // Render markdown -> HTML (sanitized)
        const html = DOMPurify.sanitize(marked.parse(md));
        $('#content').innerHTML = html;

        // Fix relative assets (images/links) to point at raw base
        absolutizeLinks($('#content'), base);

      } catch (err) {
        console.error(err);
        $('#content').innerHTML = `
          <p><strong>Failed to load README</strong></p>
          <p class="muted">${err.message}</p>
          <p class="muted">Tried: README.md, readme.md, README.MD, README.rst, docs/README.md</p>
        `;
      }
    })();
  </script>
</body>
</html>
